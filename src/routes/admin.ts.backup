import { Hono } from 'hono';
import { Env, ApiResponse, Grant } from '../types';
import { insert, executeQuery, paginate, fetchOne } from '../utils/db.utils';
import { GoogleGenerativeAI } from '@google/generative-ai';

// NOTE: CSV/Excel import features are disabled in production
// Cloudflare Workers doesn't support Node.js modules (papaparse, xlsx)
// Use WordPress REST API sync instead: POST /api/wordpress/sync

const admin = new Hono<{ Bindings: Env }>();

// ç°¡æ˜“èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
admin.use('/*', async (c, next) => {
  const authHeader = c.req.header('Authorization');
  const apiKey = authHeader?.replace('Bearer ', '');
  
  // é–‹ç™ºç’°å¢ƒã§ã¯ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼ˆæœ¬ç•ªã§ã¯é©åˆ‡ãªèªè¨¼ã‚’å®Ÿè£…ï¼‰
  const validApiKey = c.env.JWT_SECRET || 'dev-secret-key';
  
  if (apiKey !== validApiKey) {
    return c.json({ success: false, error: 'èªè¨¼ãŒå¿…è¦ã§ã™' }, 401);
  }
  
  await next();
});

// ========================================
// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
// ========================================

// CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
admin.post('/import/grants-csv', async (c) => {
  try {
    const formData = await c.req.formData();
    const file = formData.get('file') as File;
    
    if (!file) {
      return c.json({ success: false, error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' }, 400);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åãƒã‚§ãƒƒã‚¯
    if (!file.name.endsWith('.csv')) {
      return c.json({ success: false, error: 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆ.csvï¼‰' }, 400);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10MBï¼‰
    if (file.size > 10 * 1024 * 1024) {
      return c.json({ success: false, error: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„' }, 400);
    }
    
    // ãƒã‚¤ãƒˆé…åˆ—ã‚’å–å¾—ã—ã¦æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•æ¤œå‡º
    const arrayBuffer = await file.arrayBuffer();
    const bytes = new Uint8Array(arrayBuffer);
    
    // UTF-8 BOMãƒã‚§ãƒƒã‚¯
    const hasUTF8BOM = bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF;
    
    // TextDecoderã§å¤‰æ›ï¼ˆUTF-8ã‚’è©¦ã™ï¼‰
    let text: string;
    try {
      const decoder = new TextDecoder('utf-8', { fatal: true });
      text = decoder.decode(bytes);
      console.log('âœ… UTF-8ã§ãƒ‡ã‚³ãƒ¼ãƒ‰æˆåŠŸ');
    } catch (e) {
      // UTF-8ã§å¤±æ•—ã—ãŸå ´åˆã€Shift-JISã‚’è©¦ã™ï¼ˆæ—¥æœ¬èªç’°å¢ƒã§ä¸€èˆ¬çš„ï¼‰
      try {
        const decoder = new TextDecoder('shift-jis');
        text = decoder.decode(bytes);
        console.log('âœ… Shift-JISã§ãƒ‡ã‚³ãƒ¼ãƒ‰æˆåŠŸ');
      } catch (e2) {
        // æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦UTF-8ã§ç„¡ç†ã‚„ã‚Šèª­ã‚€
        const decoder = new TextDecoder('utf-8', { fatal: false });
        text = decoder.decode(bytes);
        console.log('âš ï¸ UTF-8ï¼ˆã‚¨ãƒ©ãƒ¼ç„¡è¦–ï¼‰ã§ãƒ‡ã‚³ãƒ¼ãƒ‰');
      }
    }
    
    // CSVè§£æ
    const parseResult = Papa.parse(text, {
      header: true,
      skipEmptyLines: true
    });
    
    if (parseResult.errors.length > 0) {
      return c.json({ 
        success: false, 
        error: 'CSVã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ',
        details: parseResult.errors 
      }, 400);
    }
    
    const csvData = parseResult.data as any[];
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨: æœ€åˆã®è¡Œã®ã‚«ãƒ©ãƒ åã‚’ç¢ºèª
    if (csvData.length > 0) {
      console.log('ğŸ“Š CSVã‚«ãƒ©ãƒ å:', Object.keys(csvData[0]));
      console.log('ğŸ“Š æœ€åˆã®ãƒ‡ãƒ¼ã‚¿è¡Œ:', csvData[0]);
    }
    
    // ã‚«ãƒ©ãƒ åãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæŸ”è»Ÿãªæ—¥æœ¬èªã‚«ãƒ©ãƒ åå¯¾å¿œï¼‰
    const grants = csvData.map((row: any, index: number) => {
      // åˆ—ç•ªå·ã«ã‚ˆã‚‹å–å¾—ã‚’å„ªå…ˆï¼ˆæ–‡å­—åŒ–ã‘å¯¾ç­–ï¼‰
      const rowValues = Object.values(row);
      const keys = Object.keys(row);
      
      // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      const getColumn = (colIndex: number, ...fallbackKeys: string[]) => {
        // 1. åˆ—ç•ªå·ã§ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
        if (rowValues[colIndex] !== undefined && rowValues[colIndex] !== '') {
          return rowValues[colIndex];
        }
        // 2. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚­ãƒ¼ã§æ¤œç´¢
        for (const key of fallbackKeys) {
          if (row[key] !== undefined && row[key] !== '') {
            return row[key];
          }
        }
        return undefined;
      };
      
      // æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œã—ãŸãƒãƒƒãƒ”ãƒ³ã‚°
      // åˆ—é †åº: ID, Title, Content, Excerpt, Permalink, admin_notes, deadline_date, max_amount_numeric, åŠ©æˆé‡‘ã‚«ãƒ†ã‚´ãƒªãƒ¼, å¯¾è±¡éƒ½é“åºœçœŒ, åŠ©æˆé‡‘ã‚¿ã‚°, å¯¾è±¡å¸‚ç”ºæ‘
      
      // IDã®å–å¾—ï¼ˆåˆ—0ï¼‰
      const wordpress_id = parseInt(
        getColumn(0, 'ID', 'wordpress_id', 'id', 'ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¹ID', 'è¨˜äº‹ID') || 
        `${Date.now()}${index}`
      ) || Math.floor(Math.random() * 1000000);
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—ï¼ˆåˆ—1ï¼‰
      const rawTitle = getColumn(1, 'Title', 'title', 'ã‚¿ã‚¤ãƒˆãƒ«', 'è£œåŠ©é‡‘å', 'åç§°', 'äº‹æ¥­å');
      const title = rawTitle && rawTitle.toString().trim() !== '' 
        ? rawTitle.toString()
        : `ç„¡é¡Œã®è£œåŠ©é‡‘ (ID: ${wordpress_id})`;
      
      // ãƒ‘ãƒ¼ãƒãƒªãƒ³ã‚¯ã®å–å¾—ï¼ˆåˆ—4ï¼‰
      const permalink = getColumn(4, 'Permalink', 'permalink', 'ãƒ‘ãƒ¼ãƒãƒªãƒ³ã‚¯', 'URL', 'url') || '';
      
      // deadline_dateã®å–å¾—ï¼ˆåˆ—6ï¼‰â€»last_updatedã‚‚å—ã‘å…¥ã‚Œã‚‹
      const deadlineDate = getColumn(6, 'deadline_date', 'last_updated', 'Deadline Date', 'ç”³è«‹æœŸé™', 'ç· åˆ‡æ—¥', 'æœŸé™', 'æ›´æ–°æ—¥') || null;
      
      // max_amount_numericã®å–å¾—ï¼ˆåˆ—7ï¼‰
      const maxAmountNumeric = parseInt(
        getColumn(7, 'max_amount_numeric', 'Max Amount Numeric', 'è£œåŠ©ä¸Šé™é¡', 'æœ€å¤§é‡‘é¡') || '0'
      ) || null;
      
      return {
        wordpress_id,
        title,
        content: getColumn(2, 'Content', 'content', 'å†…å®¹', 'è©³ç´°', 'èª¬æ˜', 'æ¦‚è¦') || '',
        excerpt: getColumn(3, 'Excerpt', 'excerpt', 'è¦ç´„', 'æŠœç²‹') || '',
        status: 'publish',
        updated_at: new Date().toISOString(),
        // Permalinkã‚’ official_url ã¨ã—ã¦ä¿å­˜
        official_url: permalink,
        // admin_notesï¼ˆåˆ—5ï¼‰
        admin_notes: getColumn(5, 'admin_notes', 'Admin Notes', 'ç®¡ç†ãƒ¡ãƒ¢', 'ãƒ¡ãƒ¢') || '',
        // deadline_dateï¼ˆåˆ—6ï¼‰
        deadline_date: deadlineDate,
        deadline_display: deadlineDate || '',
        // max_amount_numericï¼ˆåˆ—7ï¼‰
        max_amount_numeric: maxAmountNumeric,
        max_amount_display: maxAmountNumeric ? `æœ€å¤§${(maxAmountNumeric / 10000).toLocaleString()}ä¸‡å††` : '',
        // åŠ©æˆé‡‘ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆåˆ—8ï¼‰
        categories: (() => {
          const catValue = getColumn(8, 'åŠ©æˆé‡‘ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'categories', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'ã‚«ãƒ†ã‚´ãƒª');
          return typeof catValue === 'string' && catValue.trim() !== ''
            ? catValue.split(',').map((s: string) => s.trim()).filter(Boolean)
            : [];
        })(),
        // å¯¾è±¡éƒ½é“åºœçœŒï¼ˆåˆ—9ï¼‰
        prefecture_name: getColumn(9, 'å¯¾è±¡éƒ½é“åºœçœŒ', 'prefecture_name', 'éƒ½é“åºœçœŒ', 'çœŒå') || '',
        // åŠ©æˆé‡‘ã‚¿ã‚°ï¼ˆåˆ—10ï¼‰
        tags: (() => {
          const tagValue = getColumn(10, 'åŠ©æˆé‡‘ã‚¿ã‚°', 'tags', 'ã‚¿ã‚°');
          return typeof tagValue === 'string' && tagValue.trim() !== ''
            ? tagValue.split(',').map((s: string) => s.trim()).filter(Boolean)
            : [];
        })(),
        // å¯¾è±¡å¸‚ç”ºæ‘ï¼ˆåˆ—11ï¼‰
        target_municipality: getColumn(11, 'å¯¾è±¡å¸‚ç”ºæ‘', 'target_municipality', 'å¸‚åŒºç”ºæ‘', 'å¸‚ç”ºæ‘') || null,
        // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        organization: '',
        organization_type: '',
        grant_target: '',
        application_method: '',
        contact_info: '',
        regional_limitation: '',
        application_status: '',
        target_prefecture_code: null
      };
    });
    
    // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ã‚’å‘¼ã³å‡ºã—
    const batch_size = parseInt(formData.get('batch_size') as string) || 50;
    const skip_duplicates = formData.get('skip_duplicates') === 'true';
    
    // æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
    const stats = {
      total: grants.length,
      inserted: 0,
      updated: 0,
      skipped: 0,
      failed: 0,
      errors: [] as Array<{ row: number; wordpress_id?: number; title?: string; error: string }>,
      processing_time_ms: 0
    };
    
    const startTime = Date.now();
    
    for (let i = 0; i < grants.length; i++) {
      const row = grants[i];
      
      try {
        // ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯è­¦å‘Šã™ã‚‹ãŒã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ç¶šè¡Œ
        if (!row.title || row.title.trim() === '') {
          console.warn(`Row ${i + 1}: ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
        }
        
        const categories = Array.isArray(row.categories) 
          ? JSON.stringify(row.categories)
          : '[]';
        
        const tags = Array.isArray(row.tags)
          ? JSON.stringify(row.tags)
          : '[]';
        
        const existing = await fetchOne(
          c.env.DB,
          'SELECT id FROM grants WHERE wordpress_id = ?',
          [row.wordpress_id]
        );
        
        if (existing) {
          if (skip_duplicates) {
            stats.skipped++;
            continue;
          }
          
          await c.env.DB.prepare(`
            UPDATE grants SET
              title = ?, content = ?, excerpt = ?, status = ?, updated_at = ?,
              max_amount_display = ?, max_amount_numeric = ?,
              deadline_display = ?, deadline_date = ?,
              organization = ?, organization_type = ?,
              grant_target = ?, application_method = ?, contact_info = ?, official_url = ?,
              target_prefecture_code = ?, prefecture_name = ?, target_municipality = ?,
              regional_limitation = ?, application_status = ?,
              categories = ?, tags = ?, admin_notes = ?, updated_system_at = datetime('now')
            WHERE wordpress_id = ?
          `).bind(
            row.title, row.content || null, row.excerpt || null, 'publish', row.updated_at || new Date().toISOString(),
            row.max_amount_display || null, row.max_amount_numeric || null,
            row.deadline_display || null, row.deadline_date || null,
            row.organization || null, row.organization_type || null,
            row.grant_target || null, row.application_method || null, row.contact_info || null, row.official_url || null,
            row.target_prefecture_code || null, row.prefecture_name || null, row.target_municipality || null,
            row.regional_limitation || null, row.application_status || null,
            categories, tags, row.admin_notes || null, row.wordpress_id
          ).run();
          
          stats.updated++;
        } else {
          await c.env.DB.prepare(`
            INSERT INTO grants (
              wordpress_id, title, content, excerpt, status,
              created_at, updated_at,
              max_amount_display, max_amount_numeric,
              deadline_display, deadline_date,
              organization, organization_type,
              grant_target, application_method, contact_info, official_url,
              target_prefecture_code, prefecture_name, target_municipality,
              regional_limitation, application_status,
              categories, tags, admin_notes
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(
            row.wordpress_id, row.title, row.content || null, row.excerpt || null, 'publish',
            new Date().toISOString(), row.updated_at || new Date().toISOString(),
            row.max_amount_display || null, row.max_amount_numeric || null,
            row.deadline_display || null, row.deadline_date || null,
            row.organization || null, row.organization_type || null,
            row.grant_target || null, row.application_method || null, row.contact_info || null, row.official_url || null,
            row.target_prefecture_code || null, row.prefecture_name || null, row.target_municipality || null,
            row.regional_limitation || null, row.application_status || null,
            categories, tags, row.admin_notes || null
          ).run();
          
          stats.inserted++;
        }
        
      } catch (error) {
        stats.failed++;
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error(`Row ${i + 1} import failed:`, errorMessage, 'Data:', {
          wordpress_id: row.wordpress_id,
          title: row.title
        });
        stats.errors.push({
          row: i + 1,
          wordpress_id: row.wordpress_id,
          title: row.title,
          error: errorMessage
        });
      }
      
      if ((i + 1) % 100 === 0) {
        console.log(`CSV Import progress: ${i + 1}/${grants.length} processed`);
      }
    }
    
    stats.processing_time_ms = Date.now() - startTime;
    
    await insert(c.env.DB, 'system_logs', {
      log_type: 'csv_import',
      message: `CSV import completed: ${stats.inserted} inserted, ${stats.updated} updated, ${stats.skipped} skipped, ${stats.failed} failed`,
      details: JSON.stringify({ ...stats, filename: file.name })
    });
    
    return c.json({
      success: true,
      data: {
        stats,
        summary: {
          filename: file.name,
          file_size: `${(file.size / 1024).toFixed(2)} KB`,
          success_rate: ((stats.inserted + stats.updated) / stats.total * 100).toFixed(2) + '%',
          processing_time: (stats.processing_time_ms / 1000).toFixed(2) + 's',
          avg_time_per_record: (stats.processing_time_ms / stats.total).toFixed(2) + 'ms'
        }
      }
    });
    
  } catch (error) {
    console.error('CSV import error:', error);
    return c.json({ 
      success: false, 
      error: 'CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
      details: error instanceof Error ? error.message : String(error)
    }, 500);
  }
});

// Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (.xlsx, .xls)
admin.post('/import/grants-excel', async (c) => {
  try {
    const formData = await c.req.formData();
    const file = formData.get('file') as File;
    
    if (!file) {
      return c.json({ success: false, error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' }, 400);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«åãƒã‚§ãƒƒã‚¯
    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
      return c.json({ success: false, error: 'Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆ.xlsx ã¾ãŸã¯ .xlsï¼‰' }, 400);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å¤§10MBï¼‰
    if (file.size > 10 * 1024 * 1024) {
      return c.json({ success: false, error: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„' }, 400);
    }
    
    const arrayBuffer = await file.arrayBuffer();
    const buffer = new Uint8Array(arrayBuffer);
    
    // Excelè§£æ
    const workbook = XLSX.read(buffer, { type: 'array' });
    
    // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    
    // JSONå½¢å¼ã«å¤‰æ›
    const excelData = XLSX.utils.sheet_to_json(worksheet);
    
    if (!excelData || excelData.length === 0) {
      return c.json({ 
        success: false, 
        error: 'Excelãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“' 
      }, 400);
    }
    
    // æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œã—ãŸãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆExcelç‰ˆï¼‰
    // åˆ—é †åº: ID, Title, Content, Excerpt, Permalink, admin_notes, deadline_date, max_amount_numeric, åŠ©æˆé‡‘ã‚«ãƒ†ã‚´ãƒªãƒ¼, å¯¾è±¡éƒ½é“åºœçœŒ, åŠ©æˆé‡‘ã‚¿ã‚°, å¯¾è±¡å¸‚ç”ºæ‘
    const grants = excelData.map((row: any, index: number) => {
      // IDã®å–å¾—
      const wordpress_id = parseInt(
        row['ID'] || row['wordpress_id'] || row['id'] || 
        row['A'] || // Aåˆ—ãŒIDã®å ´åˆ
        row['ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¹ID'] || row['è¨˜äº‹ID'] || 
        `${Date.now()}${index}` // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— + ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
      ) || Math.floor(Math.random() * 1000000);
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—
      const title = row['Title'] || row['title'] || row['ã‚¿ã‚¤ãƒˆãƒ«'] || row['è£œåŠ©é‡‘å'] || 
                    row['B'] || // Båˆ—ãŒã‚¿ã‚¤ãƒˆãƒ«ã®å ´åˆ
                    row['åç§°'] || row['äº‹æ¥­å'] || 
                    `ç„¡é¡Œã®è£œåŠ©é‡‘ (ID: ${wordpress_id})`;
      
      // ãƒ‘ãƒ¼ãƒãƒªãƒ³ã‚¯ã®å–å¾—
      const permalink = row['Permalink'] || row['permalink'] || row['ãƒ‘ãƒ¼ãƒãƒªãƒ³ã‚¯'] || row['URL'] || row['url'] || '';
      
      // deadline_dateã®å–å¾—ï¼ˆlast_updatedã‚‚å—ã‘å…¥ã‚Œã‚‹ï¼‰
      const deadlineDate = row['deadline_date'] || row['last_updated'] || row['Deadline Date'] || row['ç”³è«‹æœŸé™'] || row['ç· åˆ‡æ—¥'] || row['æœŸé™'] || row['æ›´æ–°æ—¥'] || null;
      
      // max_amount_numericã®å–å¾—
      const maxAmountNumeric = parseInt(
        row['max_amount_numeric'] || row['Max Amount Numeric'] || row['è£œåŠ©ä¸Šé™é¡'] || row['æœ€å¤§é‡‘é¡'] || '0'
      ) || null;
      
      return {
        wordpress_id,
        title,
        content: row['Content'] || row['content'] || row['å†…å®¹'] || row['è©³ç´°'] || row['èª¬æ˜'] || row['æ¦‚è¦'] || '',
        excerpt: row['Excerpt'] || row['excerpt'] || row['è¦ç´„'] || row['æŠœç²‹'] || '',
        status: 'publish',
        updated_at: new Date().toISOString(),
        // Permalinkã‚’ official_url ã¨ã—ã¦ä¿å­˜
        official_url: permalink,
        // admin_notes
        admin_notes: row['admin_notes'] || row['Admin Notes'] || row['ç®¡ç†ãƒ¡ãƒ¢'] || row['ãƒ¡ãƒ¢'] || '',
        // deadline_date
        deadline_date: deadlineDate,
        deadline_display: deadlineDate || '',
        // max_amount_numeric
        max_amount_numeric: maxAmountNumeric,
        max_amount_display: maxAmountNumeric ? `æœ€å¤§${(maxAmountNumeric / 10000).toLocaleString()}ä¸‡å††` : '',
        // åŠ©æˆé‡‘ã‚«ãƒ†ã‚´ãƒªãƒ¼
        categories: typeof row['åŠ©æˆé‡‘ã‚«ãƒ†ã‚´ãƒªãƒ¼'] === 'string' 
          ? row['åŠ©æˆé‡‘ã‚«ãƒ†ã‚´ãƒªãƒ¼'].split(',').map((s: string) => s.trim()).filter(Boolean)
          : typeof row['categories'] === 'string'
          ? row['categories'].split(',').map((s: string) => s.trim()).filter(Boolean)
          : typeof row['ã‚«ãƒ†ã‚´ãƒªãƒ¼'] === 'string'
          ? row['ã‚«ãƒ†ã‚´ãƒªãƒ¼'].split(',').map((s: string) => s.trim()).filter(Boolean)
          : [],
        // å¯¾è±¡éƒ½é“åºœçœŒ
        prefecture_name: row['å¯¾è±¡éƒ½é“åºœçœŒ'] || row['prefecture_name'] || row['éƒ½é“åºœçœŒ'] || row['çœŒå'] || '',
        // åŠ©æˆé‡‘ã‚¿ã‚°
        tags: typeof row['åŠ©æˆé‡‘ã‚¿ã‚°'] === 'string'
          ? row['åŠ©æˆé‡‘ã‚¿ã‚°'].split(',').map((s: string) => s.trim()).filter(Boolean)
          : typeof row['tags'] === 'string'
          ? row['tags'].split(',').map((s: string) => s.trim()).filter(Boolean)
          : typeof row['ã‚¿ã‚°'] === 'string'
          ? row['ã‚¿ã‚°'].split(',').map((s: string) => s.trim()).filter(Boolean)
          : [],
        // å¯¾è±¡å¸‚ç”ºæ‘
        target_municipality: row['å¯¾è±¡å¸‚ç”ºæ‘'] || row['target_municipality'] || row['å¸‚åŒºç”ºæ‘'] || row['å¸‚ç”ºæ‘'] || null,
        // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        organization: '',
        organization_type: '',
        grant_target: '',
        application_method: '',
        contact_info: '',
        regional_limitation: '',
        application_status: '',
        target_prefecture_code: null
      };
    });
    
    const batch_size = parseInt(formData.get('batch_size') as string) || 50;
    const skip_duplicates = formData.get('skip_duplicates') === 'true';
    
    const stats = {
      total: grants.length,
      inserted: 0,
      updated: 0,
      skipped: 0,
      failed: 0,
      errors: [] as Array<{ row: number; wordpress_id?: number; title?: string; error: string }>,
      processing_time_ms: 0
    };
    
    const startTime = Date.now();
    
    for (let i = 0; i < grants.length; i++) {
      const row = grants[i];
      
      try {
        // ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã®å ´åˆã¯è­¦å‘Šã™ã‚‹ãŒã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ç¶šè¡Œ
        if (!row.title || row.title.trim() === '') {
          console.warn(`Row ${i + 1}: ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
        }
        
        const categories = Array.isArray(row.categories) 
          ? JSON.stringify(row.categories)
          : '[]';
        
        const tags = Array.isArray(row.tags)
          ? JSON.stringify(row.tags)
          : '[]';
        
        const existing = await fetchOne(
          c.env.DB,
          'SELECT id FROM grants WHERE wordpress_id = ?',
          [row.wordpress_id]
        );
        
        if (existing) {
          if (skip_duplicates) {
            stats.skipped++;
            continue;
          }
          
          await c.env.DB.prepare(`
            UPDATE grants SET
              title = ?, content = ?, excerpt = ?, status = ?, updated_at = ?,
              max_amount_display = ?, max_amount_numeric = ?,
              deadline_display = ?, deadline_date = ?,
              organization = ?, organization_type = ?,
              grant_target = ?, application_method = ?, contact_info = ?, official_url = ?,
              target_prefecture_code = ?, prefecture_name = ?, target_municipality = ?,
              regional_limitation = ?, application_status = ?,
              categories = ?, tags = ?, admin_notes = ?, updated_system_at = datetime('now')
            WHERE wordpress_id = ?
          `).bind(
            row.title, row.content || null, row.excerpt || null, 'publish', row.updated_at || new Date().toISOString(),
            row.max_amount_display || null, row.max_amount_numeric || null,
            row.deadline_display || null, row.deadline_date || null,
            row.organization || null, row.organization_type || null,
            row.grant_target || null, row.application_method || null, row.contact_info || null, row.official_url || null,
            row.target_prefecture_code || null, row.prefecture_name || null, row.target_municipality || null,
            row.regional_limitation || null, row.application_status || null,
            categories, tags, row.admin_notes || null, row.wordpress_id
          ).run();
          
          stats.updated++;
        } else {
          await c.env.DB.prepare(`
            INSERT INTO grants (
              wordpress_id, title, content, excerpt, status,
              created_at, updated_at,
              max_amount_display, max_amount_numeric,
              deadline_display, deadline_date,
              organization, organization_type,
              grant_target, application_method, contact_info, official_url,
              target_prefecture_code, prefecture_name, target_municipality,
              regional_limitation, application_status,
              categories, tags, admin_notes
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(
            row.wordpress_id, row.title, row.content || null, row.excerpt || null, 'publish',
            new Date().toISOString(), row.updated_at || new Date().toISOString(),
            row.max_amount_display || null, row.max_amount_numeric || null,
            row.deadline_display || null, row.deadline_date || null,
            row.organization || null, row.organization_type || null,
            row.grant_target || null, row.application_method || null, row.contact_info || null, row.official_url || null,
            row.target_prefecture_code || null, row.prefecture_name || null, row.target_municipality || null,
            row.regional_limitation || null, row.application_status || null,
            categories, tags, row.admin_notes || null
          ).run();
          
          stats.inserted++;
        }
        
      } catch (error) {
        stats.failed++;
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error(`Row ${i + 1} import failed:`, errorMessage, 'Data:', {
          wordpress_id: row.wordpress_id,
          title: row.title
        });
        stats.errors.push({
          row: i + 1,
          wordpress_id: row.wordpress_id,
          title: row.title,
          error: errorMessage
        });
      }
      
      if ((i + 1) % 100 === 0) {
        console.log(`Excel Import progress: ${i + 1}/${grants.length} processed`);
      }
    }
    
    stats.processing_time_ms = Date.now() - startTime;
    
    await insert(c.env.DB, 'system_logs', {
      log_type: 'excel_import',
      message: `Excel import completed: ${stats.inserted} inserted, ${stats.updated} updated, ${stats.skipped} skipped, ${stats.failed} failed`,
      details: JSON.stringify({ ...stats, filename: file.name, sheet: sheetName })
    });
    
    return c.json({
      success: true,
      data: {
        stats,
        summary: {
          filename: file.name,
          sheet_name: sheetName,
          file_size: `${(file.size / 1024).toFixed(2)} KB`,
          success_rate: ((stats.inserted + stats.updated) / stats.total * 100).toFixed(2) + '%',
          processing_time: (stats.processing_time_ms / 1000).toFixed(2) + 's',
          avg_time_per_record: (stats.processing_time_ms / stats.total).toFixed(2) + 'ms'
        }
      }
    });
    
  } catch (error) {
    console.error('Excel import error:', error);
    return c.json({ 
      success: false, 
      error: 'Excelã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
      details: error instanceof Error ? error.message : String(error)
    }, 500);
  }
});

// CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆJSONå½¢å¼ã§å—ä¿¡ï¼‰ - å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆ
admin.post('/import/grants', async (c) => {
  try {
    const body = await c.req.json();
    const { grants, batch_size = 50, skip_duplicates = false } = body as { 
      grants: any[]; 
      batch_size?: number;
      skip_duplicates?: boolean;
    };
    
    if (!Array.isArray(grants) || grants.length === 0) {
      return c.json({ success: false, error: 'æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“' }, 400);
    }
    
    const stats = {
      total: grants.length,
      inserted: 0,
      updated: 0,
      skipped: 0,
      failed: 0,
      errors: [] as Array<{ row: number; wordpress_id?: number; title?: string; error: string }>,
      processing_time_ms: 0
    };
    
    const startTime = Date.now();
    
    // ãƒãƒƒãƒå‡¦ç†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ50ä»¶ãšã¤ã€æœ€å¤§100ä»¶ï¼‰
    const effectiveBatchSize = Math.min(batch_size, 100);
    
    for (let i = 0; i < grants.length; i++) {
      const row = grants[i];
      
      try {
        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
        if (!row.wordpress_id || !row.title) {
          throw new Error('å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¿ã‚°ã®é…åˆ—åŒ–
        const categories = Array.isArray(row.categories) 
          ? JSON.stringify(row.categories)
          : typeof row.categories === 'string'
          ? JSON.stringify(row.categories.split(',').map((s: string) => s.trim()))
          : '[]';
        
        const tags = Array.isArray(row.tags)
          ? JSON.stringify(row.tags)
          : typeof row.tags === 'string'
          ? JSON.stringify(row.tags.split(',').map((s: string) => s.trim()))
          : '[]';
        
        // æ—¢å­˜ãƒã‚§ãƒƒã‚¯
        const existing = await fetchOne(
          c.env.DB,
          'SELECT id FROM grants WHERE wordpress_id = ?',
          [row.wordpress_id]
        );
        
        if (existing) {
          // skip_duplicates = true ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if (skip_duplicates) {
            stats.skipped++;
            continue;
          }
          
          // æ›´æ–°
          await c.env.DB.prepare(`
            UPDATE grants SET
              title = ?,
              content = ?,
              excerpt = ?,
              status = ?,
              updated_at = ?,
              max_amount_display = ?,
              max_amount_numeric = ?,
              deadline_display = ?,
              deadline_date = ?,
              organization = ?,
              organization_type = ?,
              grant_target = ?,
              application_method = ?,
              contact_info = ?,
              official_url = ?,
              target_prefecture_code = ?,
              prefecture_name = ?,
              target_municipality = ?,
              regional_limitation = ?,
              application_status = ?,
              categories = ?,
              tags = ?,
              updated_system_at = datetime('now')
            WHERE wordpress_id = ?
          `).bind(
            row.title,
            row.content || null,
            row.excerpt || null,
            row.status || 'publish',
            row.updated_at || new Date().toISOString(),
            row.max_amount_display || null,
            row.max_amount_numeric || null,
            row.deadline_display || null,
            row.deadline_date || null,
            row.organization || null,
            row.organization_type || null,
            row.grant_target || null,
            row.application_method || null,
            row.contact_info || null,
            row.official_url || null,
            row.target_prefecture_code || null,
            row.prefecture_name || null,
            row.target_municipality || null,
            row.regional_limitation || null,
            row.application_status || null,
            categories,
            tags,
            row.wordpress_id
          ).run();
          
          stats.updated++;
        } else {
          // æŒ¿å…¥
          await c.env.DB.prepare(`
            INSERT INTO grants (
              wordpress_id, title, content, excerpt, status,
              created_at, updated_at,
              max_amount_display, max_amount_numeric,
              deadline_display, deadline_date,
              organization, organization_type,
              grant_target, application_method, contact_info, official_url,
              target_prefecture_code, prefecture_name, target_municipality,
              regional_limitation, application_status,
              categories, tags, admin_notes
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(
            row.wordpress_id,
            row.title,
            row.content || null,
            row.excerpt || null,
            row.status || 'publish',
            row.created_at || new Date().toISOString(),
            row.updated_at || new Date().toISOString(),
            row.max_amount_display || null,
            row.max_amount_numeric || null,
            row.deadline_display || null,
            row.deadline_date || null,
            row.organization || null,
            row.organization_type || null,
            row.grant_target || null,
            row.application_method || null,
            row.contact_info || null,
            row.official_url || null,
            row.target_prefecture_code || null,
            row.prefecture_name || null,
            row.target_municipality || null,
            row.regional_limitation || null,
            row.application_status || null,
            categories,
            tags
          ).run();
          
          stats.inserted++;
        }
        
      } catch (error) {
        stats.failed++;
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error(`Row ${i + 1} import failed:`, errorMessage, 'Data:', {
          wordpress_id: row.wordpress_id,
          title: row.title
        });
        stats.errors.push({
          row: i + 1,
          wordpress_id: row.wordpress_id,
          title: row.title,
          error: errorMessage
        });
      }
      
      // é€²æ—ãƒ­ã‚°ï¼ˆ100ä»¶ã”ã¨ï¼‰
      if ((i + 1) % 100 === 0) {
        console.log(`Import progress: ${i + 1}/${grants.length} processed`);
      }
    }
    
    stats.processing_time_ms = Date.now() - startTime;
    
    // ãƒ­ã‚°ä¿å­˜
    await insert(c.env.DB, 'system_logs', {
      log_type: 'import',
      message: `Import completed: ${stats.inserted} inserted, ${stats.updated} updated, ${stats.skipped} skipped, ${stats.failed} failed`,
      details: JSON.stringify(stats)
    });
    
    const response: ApiResponse = {
      success: true,
      data: { 
        stats,
        summary: {
          success_rate: ((stats.inserted + stats.updated) / stats.total * 100).toFixed(2) + '%',
          processing_time: (stats.processing_time_ms / 1000).toFixed(2) + 's',
          avg_time_per_record: (stats.processing_time_ms / stats.total).toFixed(2) + 'ms'
        }
      }
    };
    
    return c.json(response);
    
  } catch (error) {
    console.error('Import error:', error);
    return c.json({ 
      success: false, 
      error: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
      details: error instanceof Error ? error.message : String(error)
    }, 500);
  }
});

// è£œåŠ©é‡‘ä¸€è¦§å–å¾—
admin.get('/grants', async (c) => {
  try {
    const page = parseInt(c.req.query('page') || '1');
    const limit = parseInt(c.req.query('limit') || '20');
    const status = c.req.query('status') || 'publish';
    const keyword = c.req.query('keyword') || '';
    const prefecture = c.req.query('prefecture') || '';
    const wordpress_id = c.req.query('wordpress_id') || '';
    
    // æ¡ä»¶æ§‹ç¯‰
    const conditions: string[] = ['status = ?'];
    const params: any[] = [status];
    
    if (keyword) {
      conditions.push('(title LIKE ? OR organization LIKE ? OR content LIKE ?)');
      const searchTerm = `%${keyword}%`;
      params.push(searchTerm, searchTerm, searchTerm);
    }
    
    if (prefecture) {
      conditions.push('prefecture_name = ?');
      params.push(prefecture);
    }
    
    if (wordpress_id) {
      conditions.push('wordpress_id = ?');
      params.push(parseInt(wordpress_id));
    }
    
    const whereClause = conditions.join(' AND ');
    
    const result = await paginate<Grant>(
      c.env.DB,
      `SELECT * FROM grants WHERE ${whereClause} ORDER BY created_system_at DESC`,
      `SELECT COUNT(*) as count FROM grants WHERE ${whereClause}`,
      params,
      { page, limit }
    );
    
    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã®æ•´åˆæ€§: grantsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
    return c.json({ 
      success: true, 
      data: {
        grants: result.data,  // result.dataã¯é…åˆ—
        total: result.total,
        page: result.page,
        limit: result.limit,
        totalPages: result.totalPages
      }
    });
    
  } catch (error) {
    console.error('Grants fetch error:', error);
    return c.json({ success: false, error: 'è£œåŠ©é‡‘ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, 500);
  }
});

// çµ±è¨ˆæƒ…å ±å–å¾—
admin.get('/stats', async (c) => {
  try {
    const days = parseInt(c.req.query('days') || '30');
    const since = new Date();
    since.setDate(since.getDate() - days);
    const sinceStr = since.toISOString();
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±è¨ˆ
    const sessionStats = await fetchOne(
      c.env.DB,
      `SELECT 
        COUNT(*) as total_sessions,
        SUM(CASE WHEN completed = 1 THEN 1 ELSE 0 END) as completed_sessions,
        AVG(total_questions_answered) as avg_questions_answered
      FROM user_sessions
      WHERE started_at >= ?`,
      [sinceStr]
    );
    
    // è£œåŠ©é‡‘çµ±è¨ˆ
    const grantStats = await fetchOne(
      c.env.DB,
      `SELECT 
        COUNT(*) as total_grants,
        SUM(CASE WHEN status = 'publish' THEN 1 ELSE 0 END) as published_grants,
        SUM(CASE WHEN deadline_date >= date('now') OR deadline_date IS NULL THEN 1 ELSE 0 END) as active_grants
      FROM grants`
    );
    
    // ãƒãƒƒãƒãƒ³ã‚°çµ±è¨ˆ
    const matchingStats = await fetchOne(
      c.env.DB,
      `SELECT 
        COUNT(*) as total_matches,
        AVG(user_feedback) as avg_feedback_score,
        SUM(CASE WHEN user_feedback >= 4 THEN 1 ELSE 0 END) as positive_feedback_count
      FROM matching_results
      WHERE created_at >= ?`,
      [sinceStr]
    );
    
    const response: ApiResponse = {
      success: true,
      data: {
        period: { days, since: sinceStr },
        sessions: sessionStats,
        grants: grantStats,
        matching: matchingStats
      }
    };
    
    return c.json(response);
    
  } catch (error) {
    console.error('Stats error:', error);
    return c.json({ success: false, error: 'çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, 500);
  }
});

// æœ€è¿‘ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§
admin.get('/sessions', async (c) => {
  try {
    const limit = parseInt(c.req.query('limit') || '50');
    
    const sessions = await executeQuery(
      c.env.DB,
      `SELECT 
        us.*,
        (SELECT COUNT(*) FROM conversation_history WHERE session_id = us.session_id) as answer_count,
        (SELECT COUNT(*) FROM matching_results WHERE session_id = us.session_id) as match_count
      FROM user_sessions us
      ORDER BY us.started_at DESC
      LIMIT ?`,
      [limit]
    );
    
    return c.json({ success: true, data: { sessions } });
    
  } catch (error) {
    console.error('Sessions fetch error:', error);
    return c.json({ success: false, error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, 500);
  }
});

// ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°å–å¾—
admin.get('/logs', async (c) => {
  try {
    const limit = parseInt(c.req.query('limit') || '100');
    const logType = c.req.query('type');
    
    let query = 'SELECT * FROM system_logs';
    const params: any[] = [];
    
    if (logType) {
      query += ' WHERE log_type = ?';
      params.push(logType);
    }
    
    query += ' ORDER BY created_at DESC LIMIT ?';
    params.push(limit);
    
    const logs = await executeQuery(c.env.DB, query, params);
    
    return c.json({ success: true, data: { logs } });
    
  } catch (error) {
    console.error('Logs fetch error:', error);
    return c.json({ success: false, error: 'ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, 500);
  }
});

// ========================================
// ãƒ‡ãƒ¼ã‚¿å‰Šé™¤æ©Ÿèƒ½
// ========================================

// è£œåŠ©é‡‘ã‚’å€‹åˆ¥å‰Šé™¤ï¼ˆwordpress_idæŒ‡å®šï¼‰
admin.delete('/grants/:wordpress_id', async (c) => {
  try {
    const wordpress_id = parseInt(c.req.param('wordpress_id'));
    
    if (!wordpress_id) {
      return c.json({ success: false, error: 'æœ‰åŠ¹ãªwordpress_idã‚’æŒ‡å®šã—ã¦ãã ã•ã„' }, 400);
    }
    
    // å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    const existing = await fetchOne(
      c.env.DB,
      'SELECT id, title FROM grants WHERE wordpress_id = ?',
      [wordpress_id]
    );
    
    if (!existing) {
      return c.json({ success: false, error: 'æŒ‡å®šã•ã‚ŒãŸè£œåŠ©é‡‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }, 404);
    }
    
    // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼ˆå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„å¯¾å¿œï¼‰
    // 1. matching_resultsã‹ã‚‰å‰Šé™¤
    await c.env.DB.prepare('DELETE FROM matching_results WHERE grant_id IN (SELECT id FROM grants WHERE wordpress_id = ?)')
      .bind(wordpress_id)
      .run();
    
    // 2. grantsã‹ã‚‰å‰Šé™¤
    await c.env.DB.prepare('DELETE FROM grants WHERE wordpress_id = ?')
      .bind(wordpress_id)
      .run();
    
    // ãƒ­ã‚°ä¿å­˜
    await insert(c.env.DB, 'system_logs', {
      log_type: 'delete',
      message: `Grant deleted: ${existing.title}`,
      details: JSON.stringify({ wordpress_id, title: existing.title })
    });
    
    return c.json({ 
      success: true, 
      data: { 
        deleted_grant: existing,
        message: 'è£œåŠ©é‡‘ã‚’å‰Šé™¤ã—ã¾ã—ãŸ' 
      } 
    });
    
  } catch (error) {
    console.error('Delete error:', error);
    return c.json({ 
      success: false, 
      error: 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',
      details: error instanceof Error ? error.message : String(error)
    }, 500);
  }
});

// è£œåŠ©é‡‘ã‚’ä¸€æ‹¬å‰Šé™¤ï¼ˆæ¡ä»¶æŒ‡å®šï¼‰
admin.post('/grants/bulk-delete', async (c) => {
  try {
    const body = await c.req.json();
    const { wordpress_ids, category, prefecture_code, status, all } = body;
    
    let query = 'DELETE FROM grants WHERE ';
    const conditions: string[] = [];
    const params: any[] = [];
    
    // å…¨å‰Šé™¤ãƒ•ãƒ©ã‚°ï¼ˆå±é™ºãªã®ã§ç¢ºèªå¿…é ˆï¼‰
    if (all === true) {
      const confirmToken = body.confirm_token;
      if (confirmToken !== 'DELETE_ALL_GRANTS_CONFIRMED') {
        return c.json({ 
          success: false, 
          error: 'å…¨å‰Šé™¤ã«ã¯ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚confirm_token: "DELETE_ALL_GRANTS_CONFIRMED" ã‚’æŒ‡å®šã—ã¦ãã ã•ã„' 
        }, 400);
      }
      
      const count = await fetchOne(c.env.DB, 'SELECT COUNT(*) as count FROM grants');
      
      // å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„å¯¾å¿œ: é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«å‰Šé™¤
      await c.env.DB.prepare('DELETE FROM matching_results').run();
      await c.env.DB.prepare('DELETE FROM grants').run();
      
      await insert(c.env.DB, 'system_logs', {
        log_type: 'bulk_delete',
        message: `All grants deleted (${count.count} records)`,
        details: JSON.stringify({ count: count.count })
      });
      
      return c.json({ 
        success: true, 
        data: { 
          deleted_count: count.count,
          message: 'å…¨ã¦ã®è£œåŠ©é‡‘ã‚’å‰Šé™¤ã—ã¾ã—ãŸ' 
        } 
      });
    }
    
    // wordpress_idsé…åˆ—ã«ã‚ˆã‚‹å‰Šé™¤
    if (wordpress_ids && Array.isArray(wordpress_ids) && wordpress_ids.length > 0) {
      const placeholders = wordpress_ids.map(() => '?').join(',');
      conditions.push(`wordpress_id IN (${placeholders})`);
      params.push(...wordpress_ids);
    }
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã‚ˆã‚‹å‰Šé™¤
    if (category) {
      conditions.push(`categories LIKE ?`);
      params.push(`%"${category}"%`);
    }
    
    // éƒ½é“åºœçœŒã«ã‚ˆã‚‹å‰Šé™¤
    if (prefecture_code) {
      conditions.push(`target_prefecture_code = ?`);
      params.push(prefecture_code);
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹å‰Šé™¤
    if (status) {
      conditions.push(`status = ?`);
      params.push(status);
    }
    
    if (conditions.length === 0) {
      return c.json({ 
        success: false, 
        error: 'å‰Šé™¤æ¡ä»¶ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆwordpress_ids, category, prefecture_code, status, ã¾ãŸã¯ allï¼‰' 
      }, 400);
    }
    
    query += conditions.join(' AND ');
    
    // å‰Šé™¤å‰ã«ä»¶æ•°ç¢ºèª
    const countQuery = 'SELECT COUNT(*) as count FROM grants WHERE ' + conditions.join(' AND ');
    const countResult = await fetchOne(c.env.DB, countQuery, params);
    
    if (countResult.count === 0) {
      return c.json({ 
        success: false, 
        error: 'æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è£œåŠ©é‡‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' 
      }, 404);
    }
    
    // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼ˆå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„å¯¾å¿œï¼‰
    // 1. matching_resultsã‹ã‚‰å‰Šé™¤
    const grantIdsQuery = 'SELECT id FROM grants WHERE ' + conditions.join(' AND ');
    const grantIds = await executeQuery(c.env.DB, grantIdsQuery, params);
    
    if (grantIds.length > 0) {
      const ids = grantIds.map((g: any) => g.id);
      const placeholders = ids.map(() => '?').join(',');
      await c.env.DB.prepare(`DELETE FROM matching_results WHERE grant_id IN (${placeholders})`)
        .bind(...ids)
        .run();
    }
    
    // 2. grantsã‹ã‚‰å‰Šé™¤
    await c.env.DB.prepare(query).bind(...params).run();
    
    // ãƒ­ã‚°ä¿å­˜
    await insert(c.env.DB, 'system_logs', {
      log_type: 'bulk_delete',
      message: `Bulk delete: ${countResult.count} grants`,
      details: JSON.stringify({ count: countResult.count, conditions: body })
    });
    
    return c.json({ 
      success: true, 
      data: { 
        deleted_count: countResult.count,
        message: `${countResult.count}ä»¶ã®è£œåŠ©é‡‘ã‚’å‰Šé™¤ã—ã¾ã—ãŸ` 
      } 
    });
    
  } catch (error) {
    console.error('Bulk delete error:', error);
    return c.json({ 
      success: false, 
      error: 'ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',
      details: error instanceof Error ? error.message : String(error)
    }, 500);
  }
});

// ========================================
// Gemini API Key ç®¡ç†
// ========================================

// ç¾åœ¨ã®API Keyè¨­å®šã‚’ç¢ºèªï¼ˆãƒã‚¹ã‚¯è¡¨ç¤ºï¼‰
admin.get('/config/gemini', async (c) => {
  try {
    const apiKey = c.env.GEMINI_API_KEY;
    
    if (!apiKey) {
      return c.json({ 
        success: true, 
        data: { 
          configured: false,
          message: 'Gemini API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' 
        } 
      });
    }
    
    // APIã‚­ãƒ¼ã®æœ€åˆã¨æœ€å¾Œã®4æ–‡å­—ã ã‘è¡¨ç¤º
    const maskedKey = apiKey.length > 8 
      ? `${apiKey.substring(0, 4)}${'*'.repeat(apiKey.length - 8)}${apiKey.substring(apiKey.length - 4)}`
      : '****';
    
    return c.json({ 
      success: true, 
      data: { 
        configured: true,
        masked_key: maskedKey,
        key_length: apiKey.length,
        message: 'Gemini API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™' 
      } 
    });
    
  } catch (error) {
    console.error('Config fetch error:', error);
    return c.json({ success: false, error: 'è¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, 500);
  }
});

// Gemini API Keyã‚’ãƒ†ã‚¹ãƒˆ
admin.post('/config/gemini/test', async (c) => {
  try {
    const body = await c.req.json();
    const testKey = body.api_key || c.env.GEMINI_API_KEY;
    
    if (!testKey) {
      return c.json({ 
        success: false, 
        error: 'API KeyãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' 
      }, 400);
    }
    
    try {
      const genAI = new GoogleGenerativeAI(testKey);
      const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });
      
      // ç°¡å˜ãªãƒ†ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
      const result = await model.generateContent('ã“ã‚“ã«ã¡ã¯ã€‚ã“ã‚Œã¯APIã‚­ãƒ¼ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ã€ŒOKã€ã¨ã ã‘è¿”ç­”ã—ã¦ãã ã•ã„ã€‚');
      const response = await result.response;
      const text = response.text();
      
      return c.json({ 
        success: true, 
        data: { 
          valid: true,
          test_response: text.substring(0, 100), // æœ€åˆã®100æ–‡å­—ã ã‘
          message: 'API Keyã¯æœ‰åŠ¹ã§ã™' 
        } 
      });
      
    } catch (apiError) {
      return c.json({ 
        success: false, 
        data: {
          valid: false,
          message: 'API KeyãŒç„¡åŠ¹ã§ã™',
          error: apiError instanceof Error ? apiError.message : String(apiError)
        }
      }, 400);
    }
    
  } catch (error) {
    console.error('API test error:', error);
    return c.json({ 
      success: false, 
      error: 'APIãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
      details: error instanceof Error ? error.message : String(error)
    }, 500);
  }
});

// .dev.vars ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã®èª¬æ˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
admin.get('/config/guide', async (c) => {
  return c.json({
    success: true,
    data: {
      message: 'Gemini API Keyã®è¨­å®šæ–¹æ³•',
      development: {
        title: 'é–‹ç™ºç’°å¢ƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰',
        steps: [
          {
            step: 1,
            title: '.dev.vars ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†',
            description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã® .dev.vars ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€ä»¥ä¸‹ã®å½¢å¼ã§è¨­å®šã—ã¦ãã ã•ã„',
            example: 'GEMINI_API_KEY=AIzaSy...(your-actual-api-key)'
          },
          {
            step: 2,
            title: 'ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•',
            description: 'PM2ã‚’å†èµ·å‹•ã—ã¦ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿ã¾ã™',
            command: 'pm2 restart webapp'
          },
          {
            step: 3,
            title: 'APIã‚­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ',
            description: 'ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„',
            endpoints: [
              'GET /api/admin/config/gemini - è¨­å®šç¢ºèª',
              'POST /api/admin/config/gemini/test - APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆ'
            ]
          }
        ]
      },
      production: {
        title: 'æœ¬ç•ªç’°å¢ƒï¼ˆCloudflare Pagesï¼‰',
        steps: [
          {
            step: 1,
            title: 'Cloudflare Secretsã‚’ä½¿ç”¨',
            description: 'wranglerã‚³ãƒãƒ³ãƒ‰ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™',
            command: 'wrangler secret put GEMINI_API_KEY --project-name webapp'
          },
          {
            step: 2,
            title: 'å†ãƒ‡ãƒ—ãƒ­ã‚¤',
            description: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™',
            command: 'npm run deploy:prod'
          }
        ]
      },
      api_key_acquisition: {
        title: 'Gemini API Keyã®å–å¾—æ–¹æ³•',
        url: 'https://aistudio.google.com/app/apikey',
        steps: [
          '1. Google AI Studioã«ã‚¢ã‚¯ã‚»ã‚¹',
          '2. Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³',
          '3. "Get API Key"ã‚’ã‚¯ãƒªãƒƒã‚¯',
          '4. æ–°ã—ã„APIã‚­ãƒ¼ã‚’ä½œæˆ',
          '5. ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼'
        ]
      }
    }
  });
});

// ========================================
// ç’°å¢ƒå¤‰æ•°ç®¡ç†ï¼ˆé–‹ç™ºç’°å¢ƒç”¨ï¼‰
// ========================================

// ç¾åœ¨ã®ç’°å¢ƒå¤‰æ•°ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒã‚¹ã‚¯è¡¨ç¤ºï¼‰
admin.get('/config/env', async (c) => {
  try {
    const env = c.env;
    
    const envVars = {
      GEMINI_API_KEY: env.GEMINI_API_KEY ? 'configured' : 'not_configured',
      GEMINI_API_KEY_MASKED: env.GEMINI_API_KEY 
        ? `${env.GEMINI_API_KEY.substring(0, 8)}...${env.GEMINI_API_KEY.substring(env.GEMINI_API_KEY.length - 4)}`
        : null,
      JWT_SECRET: env.JWT_SECRET ? 'configured' : 'not_configured',
      DB: env.DB ? 'configured' : 'not_configured'
    };
    
    return c.json({
      success: true,
      data: {
        environment: 'development',
        variables: envVars,
        message: 'ç’°å¢ƒå¤‰æ•°ã®è¨­å®šçŠ¶æ³ã§ã™ã€‚å®Ÿéš›ã®å€¤ã¯ .dev.vars ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚'
      }
    });
    
  } catch (error) {
    console.error('Env fetch error:', error);
    return c.json({ 
      success: false, 
      error: 'ç’°å¢ƒå¤‰æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' 
    }, 500);
  }
});

export default admin;
