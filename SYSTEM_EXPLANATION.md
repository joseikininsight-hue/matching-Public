# ã‚·ã‚¹ãƒ†ãƒ ä»•çµ„ã¿ã®è©³ç´°èª¬æ˜

## å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WordPress (joseikin-insight.com)                     â”‚
â”‚  - ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—: "grant" (è£œåŠ©é‡‘)                         â”‚
â”‚  - ACFã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: çµ„ç¹”åã€é‡‘é¡ã€ç· åˆ‡ãªã©                  â”‚
â”‚  - ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼: éƒ½é“åºœçœŒã€å¸‚ç”ºæ‘ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ã‚¿ã‚°               â”‚
â”‚  - æŠ•ç¨¿æ•°: 7,949ä»¶                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ â‘  REST API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                 â”‚    GET /wp-json/wp/v2/grants
                 â”‚    ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ?per_page=100&page=1&_embed=true
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WordPress REST API                                   â”‚
â”‚  - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: /wp-json/wp/v2/grants                      â”‚
â”‚  - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³: 100ä»¶/ãƒšãƒ¼ã‚¸                              â”‚
â”‚  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:                                         â”‚
â”‚    â€¢ X-WP-Total: ç·æŠ•ç¨¿æ•°                                    â”‚
â”‚    â€¢ X-WP-TotalPages: ç·ãƒšãƒ¼ã‚¸æ•°                             â”‚
â”‚  - _embed=true: ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼æƒ…å ±ã‚’å«ã‚ã‚‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ â‘¡ JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                 â”‚    [{id, title, content, acf, _embedded}, ...]
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Cloudflare Workers (Hono Framework)                       â”‚
â”‚    ãƒ•ã‚¡ã‚¤ãƒ«: src/routes/wordpress.ts                          â”‚
â”‚                                                              â”‚
â”‚  ã€ãƒãƒƒãƒå‡¦ç†ãƒ«ãƒ¼ãƒ—ã€‘                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ while (hasMore && pagesProcessed < maxPages) {           â”‚
â”‚  â”‚   // ãƒšãƒ¼ã‚¸å˜ä½ã§WordPress APIã‚’å‘¼ã³å‡ºã—                   â”‚
â”‚  â”‚   fetch(wpApiUrl)                                        â”‚
â”‚  â”‚   allPosts.concat(wpPosts)                               â”‚
â”‚  â”‚   currentPage++                                          â”‚
â”‚  â”‚ }                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                              â”‚
â”‚  ã€ãƒ‡ãƒ¼ã‚¿å¤‰æ›å‡¦ç†ã€‘                                            â”‚
â”‚  - WordPressãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ â†’ D1ã‚«ãƒ©ãƒ ã¸ãƒãƒƒãƒ”ãƒ³ã‚°                  â”‚
â”‚  - ACFãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾— (organization, max_amount, etc.)        â”‚
â”‚  - ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼æŠ½å‡º (prefecture, category, etc.)              â”‚
â”‚  - HTMLã‚¿ã‚°é™¤å»ï¼ˆexcerptç”¨ï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ â‘¢ SQL INSERT OR REPLACE
                 â”‚    ãƒã‚¤ãƒ³ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å®‰å…¨ã«æŒ¿å…¥
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Cloudflare D1 Database (SQLite)                           â”‚
â”‚    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å: grants-db                                  â”‚
â”‚                                                              â”‚
â”‚  ã€grants ãƒ†ãƒ¼ãƒ–ãƒ«ã€‘                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ id              INTEGER PRIMARY KEY      â”‚                â”‚
â”‚  â”‚ wordpress_id    INTEGER UNIQUE           â”‚ â† WordPressæŠ•ç¨¿ID â”‚
â”‚  â”‚ title           TEXT                     â”‚ â† åŠ©æˆé‡‘ã‚¿ã‚¤ãƒˆãƒ«  â”‚
â”‚  â”‚ content         TEXT                     â”‚ â† HTMLæœ¬æ–‡       â”‚
â”‚  â”‚ excerpt         TEXT                     â”‚ â† ãƒ†ã‚­ã‚¹ãƒˆè¦ç´„   â”‚
â”‚  â”‚ organization    TEXT                     â”‚ â† å®Ÿæ–½çµ„ç¹”       â”‚
â”‚  â”‚ max_amount_display TEXT                  â”‚ â† é‡‘é¡ï¼ˆè¡¨ç¤ºç”¨ï¼‰  â”‚
â”‚  â”‚ max_amount_numeric INTEGER               â”‚ â† é‡‘é¡ï¼ˆæ•°å€¤ï¼‰    â”‚
â”‚  â”‚ deadline_display TEXT                    â”‚ â† ç· åˆ‡ï¼ˆè¡¨ç¤ºç”¨ï¼‰  â”‚
â”‚  â”‚ deadline_date   TEXT                     â”‚ â† ç· åˆ‡æ—¥         â”‚
â”‚  â”‚ official_url    TEXT                     â”‚ â† å…¬å¼URL        â”‚
â”‚  â”‚ prefecture_name TEXT                     â”‚ â† éƒ½é“åºœçœŒå     â”‚
â”‚  â”‚ target_prefecture_code TEXT              â”‚ â† éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ â”‚
â”‚  â”‚ grant_target    TEXT                     â”‚ â† å¯¾è±¡è€…         â”‚
â”‚  â”‚ application_status TEXT                  â”‚ â† ç”³è«‹çŠ¶æ…‹       â”‚
â”‚  â”‚ wp_sync_status  TEXT                     â”‚ â† åŒæœŸçŠ¶æ…‹       â”‚
â”‚  â”‚ last_wp_sync    DATETIME                 â”‚ â† æœ€çµ‚åŒæœŸæ™‚åˆ»   â”‚
â”‚  â”‚ ... (ä»–ã®ã‚«ãƒ©ãƒ )                          â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                              â”‚
â”‚  ç¾åœ¨ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: 7,949ä»¶                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‡¦ç†ãƒ•ãƒ­ãƒ¼è©³ç´°

### ã‚¹ãƒ†ãƒƒãƒ—1: API ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/wordpress/sync`

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `page`: é–‹å§‹ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
- `per_page`: 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100ï¼‰
- `max_pages`: ä¸€åº¦ã«å‡¦ç†ã™ã‚‹æœ€å¤§ãƒšãƒ¼ã‚¸æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰

**ä¾‹**:
```bash
curl "http://localhost:3000/api/wordpress/sync?page=1&per_page=100&max_pages=10"
```

ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã€Œ1ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰10ãƒšãƒ¼ã‚¸ã¾ã§ï¼ˆåˆè¨ˆ1000ä»¶ï¼‰ã€ã‚’åŒæœŸã—ã¾ã™ã€‚

---

### ã‚¹ãƒ†ãƒƒãƒ—2: WordPress API å‘¼ã³å‡ºã—ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

**ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†** (`src/routes/wordpress.ts` 50-92è¡Œ):

```typescript
while (hasMore && pagesProcessed < maxPages) {
  // WordPress REST APIã®URLæ§‹ç¯‰
  const wpApiUrl = `${wpSiteUrl}/wp-json/wp/v2/grants?per_page=${perPage}&page=${currentPage}&_embed=true`;
  
  // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  const response = await fetch(wpApiUrl, {
    headers: {
      'Authorization': `Bearer ${c.env.WORDPRESS_API_TOKEN || ''}`,
    },
  });

  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
  if (!response.ok) {
    if (response.status === 400) {
      // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã‚’è¶…ãˆãŸå ´åˆ
      hasMore = false;
      break;
    }
    throw new Error(`WordPress API error: ${response.statusText}`);
  }

  // JSON ãƒ‡ãƒ¼ã‚¿å–å¾—
  const wpPosts = await response.json();
  
  // ç©ºãªã‚‰çµ‚äº†
  if (wpPosts.length === 0) {
    hasMore = false;
    break;
  }
  
  // å…¨æŠ•ç¨¿ã«è¿½åŠ 
  allPosts = allPosts.concat(wpPosts);
  pagesProcessed++;
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç·ãƒšãƒ¼ã‚¸æ•°ã‚’å–å¾—
  const totalPages = response.headers.get('X-WP-TotalPages');
  
  // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«åˆ°é”ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
  if (totalPages && currentPage >= parseInt(totalPages)) {
    hasMore = false;
  } else {
    currentPage++; // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸
  }
}
```

**å®Ÿéš›ã®WordPress APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:

```json
[
  {
    "id": 130563,
    "title": {
      "rendered": "ã€2025å¹´å¿—æ‘©å¸‚ã€‘ãƒ©ã‚¤ãƒ•ã‚»ãƒ¼ãƒãƒ¼è³‡æ ¼å–å¾—è£œåŠ©é‡‘"
    },
    "content": {
      "rendered": "<p>è©³ç´°ãªå†…å®¹...</p>"
    },
    "excerpt": {
      "rendered": "<p>è¦ç´„...</p>"
    },
    "link": "https://joseikin-insight.com/grants/130563",
    "status": "publish",
    "acf": {
      "organization": "å¿—æ‘©å¸‚",
      "max_amount": "22,000å††",
      "max_amount_numeric": 22000,
      "deadline": "2025å¹´3æœˆ31æ—¥",
      "official_url": "https://example.com"
    },
    "_embedded": {
      "wp:term": [
        [
          {
            "id": 45,
            "name": "ä¸‰é‡çœŒ",
            "slug": "mie",
            "taxonomy": "grant_prefecture"
          }
        ],
        [
          {
            "id": 123,
            "name": "å¿—æ‘©å¸‚",
            "slug": "shima",
            "taxonomy": "grant_municipality"
          }
        ]
      ]
    }
  }
]
```

---

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã¨ãƒãƒƒãƒ”ãƒ³ã‚°

**ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†** (`src/routes/wordpress.ts` 100-187è¡Œ):

```typescript
for (const post of allPosts) {
  // â‘  ACFãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å–å¾—
  const acf = post.acf || {};
  
  // â‘¡ ã‚¿ã‚¯ã‚½ãƒãƒŸãƒ¼ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼ã€éƒ½é“åºœçœŒãªã©ï¼‰ã‚’æŠ½å‡º
  const embeddedTerms = post._embedded?.['wp:term'] || [];
  const allTerms = embeddedTerms.flat();
  
  const prefectures = allTerms.filter((t: any) => t.taxonomy === 'grant_prefecture');
  const prefectureName = prefectures.length > 0 ? prefectures[0].name : 'å…¨å›½';
  
  // â‘¢ HTMLã‚¿ã‚°é™¤å»ï¼ˆexcerptã‹ã‚‰ï¼‰
  const excerpt = post.excerpt?.rendered?.replace(/<[^>]*>/g, '') || '';
  
  // â‘£ D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŒ¿å…¥
  await db.prepare(`
    INSERT OR REPLACE INTO grants (
      wordpress_id,
      title,
      content,
      excerpt,
      organization,
      max_amount_display,
      max_amount_numeric,
      deadline_display,
      official_url,
      prefecture_name,
      target_prefecture_code,
      application_status,
      wp_sync_status,
      last_wp_sync
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
  `).bind(
    post.id,                           // wordpress_id
    post.title?.rendered || '',        // title
    post.content?.rendered || '',      // content
    excerpt,                           // excerpt
    acf.organization || 'æœªè¨­å®š',       // organization
    acf.max_amount || 'è¦ç¢ºèª',         // max_amount_display
    acf.max_amount_numeric || 0,       // max_amount_numeric
    acf.deadline || 'éšæ™‚',             // deadline_display
    acf.official_url || post.link,     // official_url
    prefectureName,                    // prefecture_name
    prefectureSlug,                    // target_prefecture_code
    acf.application_status || 'open',  // application_status
    'synced'                           // wp_sync_status
  ).run();
  
  syncedCount++;
}
```

**ãƒãƒƒãƒ”ãƒ³ã‚°è¡¨**:

| WordPress ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | D1 ã‚«ãƒ©ãƒ  | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|---------------------|-----------|----------|------|
| `post.id` | `wordpress_id` | INTEGER | WordPressæŠ•ç¨¿IDï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰ |
| `post.title.rendered` | `title` | TEXT | åŠ©æˆé‡‘ã‚¿ã‚¤ãƒˆãƒ« |
| `post.content.rendered` | `content` | TEXT | HTMLæœ¬æ–‡ |
| `post.excerpt.rendered` | `excerpt` | TEXT | ãƒ†ã‚­ã‚¹ãƒˆè¦ç´„ï¼ˆHTMLã‚¿ã‚°é™¤å»ï¼‰ |
| `acf.organization` | `organization` | TEXT | å®Ÿæ–½çµ„ç¹”å |
| `acf.max_amount` | `max_amount_display` | TEXT | é‡‘é¡è¡¨ç¤ºï¼ˆä¾‹: "22,000å††"ï¼‰ |
| `acf.max_amount_numeric` | `max_amount_numeric` | INTEGER | é‡‘é¡æ•°å€¤ï¼ˆã‚½ãƒ¼ãƒˆç”¨ï¼‰ |
| `acf.deadline` | `deadline_display` | TEXT | ç· åˆ‡è¡¨ç¤ºï¼ˆä¾‹: "2025å¹´3æœˆ31æ—¥"ï¼‰ |
| `acf.official_url` | `official_url` | TEXT | å…¬å¼ã‚µã‚¤ãƒˆURL |
| `_embedded.wp:term[prefecture]` | `prefecture_name` | TEXT | éƒ½é“åºœçœŒåï¼ˆä¾‹: "ä¸‰é‡çœŒ"ï¼‰ |
| `_embedded.wp:term[prefecture].slug` | `target_prefecture_code` | TEXT | éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "mie"ï¼‰ |
| `acf.application_status` | `application_status` | TEXT | ç”³è«‹çŠ¶æ…‹ï¼ˆä¾‹: "open"ï¼‰ |

---

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ï¼ˆINSERT OR REPLACEï¼‰

**SQL ã‚¯ã‚¨ãƒªã®æ„å‘³**:

```sql
INSERT OR REPLACE INTO grants (...)
```

ã“ã®æ§‹æ–‡ã¯ã€Œ**å†ªç­‰æ€§ï¼ˆã¹ãã¨ã†ã›ã„ï¼‰**ã€ã‚’ä¿è¨¼ã—ã¾ã™ï¼š

- **åˆå›å®Ÿè¡Œ**: æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦æŒ¿å…¥
- **2å›ç›®ä»¥é™**: `wordpress_id` ãŒåŒã˜ãªã‚‰æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°

**ãƒ¡ãƒªãƒƒãƒˆ**:
- åŒã˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚å®‰å…¨
- ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ãŒç™ºç”Ÿã—ãªã„
- æœ€æ–°ã®æƒ…å ±ã§å¸¸ã«ä¸Šæ›¸ãã•ã‚Œã‚‹

**å®Ÿéš›ã®SQLå®Ÿè¡Œä¾‹**:

```sql
-- 1å›ç›®: æ–°è¦æŒ¿å…¥
INSERT OR REPLACE INTO grants (
  wordpress_id, title, organization, max_amount_display
) VALUES (
  130563, 
  'ã€2025å¹´å¿—æ‘©å¸‚ã€‘ãƒ©ã‚¤ãƒ•ã‚»ãƒ¼ãƒãƒ¼è³‡æ ¼å–å¾—è£œåŠ©é‡‘', 
  'å¿—æ‘©å¸‚', 
  '22,000å††'
);
-- çµæœ: 1ä»¶æŒ¿å…¥

-- 2å›ç›®: åŒã˜wordpress_idã§å®Ÿè¡Œ
INSERT OR REPLACE INTO grants (
  wordpress_id, title, organization, max_amount_display
) VALUES (
  130563,  -- åŒã˜ID
  'ã€2025å¹´å¿—æ‘©å¸‚ã€‘ãƒ©ã‚¤ãƒ•ã‚»ãƒ¼ãƒãƒ¼è³‡æ ¼å–å¾—è£œåŠ©é‡‘ï¼ˆæ›´æ–°ç‰ˆï¼‰', 
  'å¿—æ‘©å¸‚', 
  '30,000å††'  -- é‡‘é¡ãŒå¤‰æ›´ã•ã‚ŒãŸ
);
-- çµæœ: æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆæ–°è¦æŒ¿å…¥ã§ã¯ãªã„ï¼‰
```

---

## ãƒãƒƒãƒå‡¦ç†ã®ä»•çµ„ã¿

### ãªãœãƒãƒƒãƒå‡¦ç†ãŒå¿…è¦ã‹ï¼Ÿ

| é …ç›® | ä¸€æ‹¬å–å¾—ï¼ˆNGï¼‰ | ãƒãƒƒãƒå‡¦ç†ï¼ˆOKï¼‰ |
|-----|---------------|----------------|
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•° | 1å› | 8å›ï¼ˆ10ãƒšãƒ¼ã‚¸Ã—8ãƒãƒƒãƒï¼‰ |
| 1å›ã‚ãŸã‚Šã®ãƒ‡ãƒ¼ã‚¿é‡ | 8000ä»¶ | 1000ä»¶ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒªã‚¹ã‚¯ | âš ï¸ é«˜ã„ | âœ… ä½ã„ |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | âš ï¸ 8000ä»¶åˆ† | âœ… 1000ä»¶åˆ† |
| ã‚¨ãƒ©ãƒ¼æ™‚ã®å½±éŸ¿ | âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å¤±æ•— | âœ… ãƒãƒƒãƒå˜ä½ã§å½±éŸ¿ç¯„å›²é™å®š |
| é€²æ—ç¢ºèª | âŒ ä¸å¯ | âœ… ãƒãƒƒãƒã”ã¨ã«ç¢ºèªå¯èƒ½ |

### ãƒãƒƒãƒå‡¦ç†ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```
ã€ãƒãƒƒãƒ1ã€‘ ãƒšãƒ¼ã‚¸1-10 (1000ä»¶)
   â†“ å‡¦ç†æ™‚é–“: ~90ç§’
ã€ãƒãƒƒãƒ2ã€‘ ãƒšãƒ¼ã‚¸11-20 (1000ä»¶)
   â†“ å‡¦ç†æ™‚é–“: ~90ç§’
ã€ãƒãƒƒãƒ3ã€‘ ãƒšãƒ¼ã‚¸21-30 (1000ä»¶)
   â†“ å‡¦ç†æ™‚é–“: ~90ç§’
ã€ãƒãƒƒãƒ4ã€‘ ãƒšãƒ¼ã‚¸31-40 (1000ä»¶)
   â†“ å‡¦ç†æ™‚é–“: ~90ç§’
ã€ãƒãƒƒãƒ5ã€‘ ãƒšãƒ¼ã‚¸41-50 (1000ä»¶)
   â†“ å‡¦ç†æ™‚é–“: ~90ç§’
ã€ãƒãƒƒãƒ6ã€‘ ãƒšãƒ¼ã‚¸51-60 (1000ä»¶)
   â†“ å‡¦ç†æ™‚é–“: ~90ç§’
ã€ãƒãƒƒãƒ7ã€‘ ãƒšãƒ¼ã‚¸61-70 (1000ä»¶)
   â†“ å‡¦ç†æ™‚é–“: ~90ç§’
ã€ãƒãƒƒãƒ8ã€‘ ãƒšãƒ¼ã‚¸71-79 (949ä»¶) â† æœ€å¾Œã®ãƒãƒƒãƒã¯ç«¯æ•°
   â†“ å‡¦ç†æ™‚é–“: ~85ç§’

åˆè¨ˆ: 7,949ä»¶ã‚’ç´„12åˆ†ã§åŒæœŸå®Œäº†
```

### è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`sync-all-grants.sh`)

```bash
#!/bin/bash

API_URL="http://localhost:3000"
PER_PAGE=100
MAX_PAGES=10      # 1ãƒãƒƒãƒã§10ãƒšãƒ¼ã‚¸å‡¦ç†
TOTAL_PAGES=80    # å…¨80ãƒšãƒ¼ã‚¸ (8000ä»¶ Ã· 100ä»¶)

START_PAGE=1
while [ $START_PAGE -le $TOTAL_PAGES ]; do
    echo "ğŸ”„ ãƒãƒƒãƒå‡¦ç†ä¸­: ãƒšãƒ¼ã‚¸ ${START_PAGE}ï½"
    
    # APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    RESPONSE=$(curl -s "${API_URL}/api/wordpress/sync?page=${START_PAGE}&max_pages=${MAX_PAGES}")
    
    # çµæœã‚’è§£æ
    SYNCED=$(echo "$RESPONSE" | jq -r '.synced_count')
    NEXT_PAGE=$(echo "$RESPONSE" | jq -r '.next_page')
    
    echo "   âœ… ${SYNCED}ä»¶ åŒæœŸå®Œäº†"
    
    # æ¬¡ã®ãƒšãƒ¼ã‚¸ãŒãªã‘ã‚Œã°çµ‚äº†
    if [ "$NEXT_PAGE" == "null" ]; then
        break
    fi
    
    START_PAGE=$NEXT_PAGE
    
    # 5ç§’å¾…æ©Ÿï¼ˆAPIã‚µãƒ¼ãƒãƒ¼ã¸ã®è² è·è»½æ¸›ï¼‰
    sleep 5
done

echo "âœ… å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†ï¼"
```

---

## API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

### 1. åŒæœŸå®Ÿè¡Œ - `/api/wordpress/sync`

**ãƒ¡ã‚½ãƒƒãƒ‰**: `GET`

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `page` (optional): é–‹å§‹ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰
- `per_page` (optional): 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100ï¼‰
- `max_pages` (optional): æœ€å¤§å‡¦ç†ãƒšãƒ¼ã‚¸æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "success": true,
  "message": "WordPress sync completed: 1000 synced, 0 errors (batch: pages 1-10)",
  "synced_count": 1000,
  "error_count": 0,
  "total_in_batch": 1000,
  "pages_processed": 10,
  "start_page": 1,
  "next_page": 11,
  "has_more": true
}
```

**ä½¿ç”¨ä¾‹**:
```bash
# å˜ä¸€ãƒãƒƒãƒï¼ˆãƒšãƒ¼ã‚¸1-10ï¼‰
curl "http://localhost:3000/api/wordpress/sync?page=1&max_pages=10"

# å¤§é‡ãƒãƒƒãƒï¼ˆãƒšãƒ¼ã‚¸1-50ï¼‰
curl "http://localhost:3000/api/wordpress/sync?page=1&max_pages=50"

# ç‰¹å®šç¯„å›²ï¼ˆãƒšãƒ¼ã‚¸21-30ï¼‰
curl "http://localhost:3000/api/wordpress/sync?page=21&max_pages=10"
```

---

### 2. åŒæœŸçŠ¶æ…‹ç¢ºèª - `/api/wordpress/sync-status`

**ãƒ¡ã‚½ãƒƒãƒ‰**: `GET`

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: ãªã—

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "success": true,
  "data": {
    "total_grants": 7949,
    "wp_synced_grants": 7949,
    "last_sync": "2025-11-06 10:01:07"
  }
}
```

**ä½¿ç”¨ä¾‹**:
```bash
curl "http://localhost:3000/api/wordpress/sync-status"
```

---

### 3. ç‰¹å®šåŠ©æˆé‡‘å–å¾— - `/api/wordpress/grants/:id`

**ãƒ¡ã‚½ãƒƒãƒ‰**: `GET`

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `id` (required): WordPressæŠ•ç¨¿ID

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": 2102,
    "wordpress_id": 130563,
    "title": "ã€2025å¹´å¿—æ‘©å¸‚ã€‘ãƒ©ã‚¤ãƒ•ã‚»ãƒ¼ãƒãƒ¼è³‡æ ¼å–å¾—è£œåŠ©é‡‘",
    "content": "<p>è©³ç´°...</p>",
    "excerpt": "è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆ",
    "organization": "å¿—æ‘©å¸‚",
    "max_amount_display": "22,000å††",
    "max_amount_numeric": 22000,
    "deadline_display": "2025å¹´3æœˆ31æ—¥",
    "official_url": "https://example.com",
    "prefecture_name": "ä¸‰é‡çœŒ",
    "application_status": "open",
    "last_wp_sync": "2025-11-06 10:01:07"
  }
}
```

**ä½¿ç”¨ä¾‹**:
```bash
curl "http://localhost:3000/api/wordpress/grants/130563"
```

---

## ãƒ‡ãƒ¼ã‚¿åŒæœŸã®æµã‚Œï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰

```
2025-11-06 09:30:00  é–‹å§‹
    â†“
09:31:30  ãƒãƒƒãƒ1å®Œäº† (ãƒšãƒ¼ã‚¸1-10)   â†’ 1,000ä»¶
09:33:00  ãƒãƒƒãƒ2å®Œäº† (ãƒšãƒ¼ã‚¸11-20)  â†’ 2,000ä»¶
09:34:30  ãƒãƒƒãƒ3å®Œäº† (ãƒšãƒ¼ã‚¸21-30)  â†’ 3,000ä»¶
09:36:00  ãƒãƒƒãƒ4å®Œäº† (ãƒšãƒ¼ã‚¸31-40)  â†’ 4,000ä»¶
09:37:30  ãƒãƒƒãƒ5å®Œäº† (ãƒšãƒ¼ã‚¸41-50)  â†’ 5,000ä»¶
09:39:00  ãƒãƒƒãƒ6å®Œäº† (ãƒšãƒ¼ã‚¸51-60)  â†’ 6,000ä»¶
09:40:30  ãƒãƒƒãƒ7å®Œäº† (ãƒšãƒ¼ã‚¸61-70)  â†’ 7,000ä»¶
09:42:00  ãƒãƒƒãƒ8å®Œäº† (ãƒšãƒ¼ã‚¸71-79)  â†’ 7,949ä»¶
    â†“
2025-11-06 09:42:00  å®Œäº†
```

**åˆè¨ˆå‡¦ç†æ™‚é–“**: ç´„12åˆ†  
**å¹³å‡å‡¦ç†é€Ÿåº¦**: ç´„662ä»¶/åˆ†  
**ã‚¨ãƒ©ãƒ¼ä»¶æ•°**: 0ä»¶

---

## æŠ€è¡“çš„ãªå·¥å¤«

### 1. å†ªç­‰æ€§ã®ä¿è¨¼

```sql
INSERT OR REPLACE INTO grants (...)
```

- ä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚åŒã˜çµæœ
- ãƒ‡ãƒ¼ã‚¿ã®é‡è¤‡ãªã—
- æœ€æ–°æƒ…å ±ã§è‡ªå‹•æ›´æ–°

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
try {
  // åŒæœŸå‡¦ç†
  syncedCount++;
} catch (error) {
  console.error(`Error syncing post ${post.id}:`, error);
  errorCount++;
  // æ¬¡ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¸ç¶™ç¶šï¼ˆå…¨ä½“ã‚’æ­¢ã‚ãªã„ï¼‰
}
```

### 3. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡

```typescript
// ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ç·ãƒšãƒ¼ã‚¸æ•°ã‚’å–å¾—
const totalPages = response.headers.get('X-WP-TotalPages');

if (currentPage >= parseInt(totalPages)) {
  hasMore = false; // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã«åˆ°é”
}
```

### 4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```bash
# 5ç§’å¾…æ©Ÿï¼ˆAPIã‚µãƒ¼ãƒãƒ¼ã¸ã®è² è·è»½æ¸›ï¼‰
sleep 5
```

### 5. é€²æ—ãƒ­ã‚®ãƒ³ã‚°

```typescript
console.log(`âœ… Fetched page ${currentPage}: ${wpPosts.length} posts`);
console.log(`ğŸ‰ Batch complete: ${allPosts.length} posts fetched`);
```

---

## ã¾ã¨ã‚

### ã“ã®ã‚·ã‚¹ãƒ†ãƒ ãŒè§£æ±ºã™ã‚‹èª²é¡Œ

1. **å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„ãªåŒæœŸ** (8000ä»¶)
2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å›é¿** (ãƒãƒƒãƒå‡¦ç†)
3. **ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§** (INSERT OR REPLACE)
4. **ã‚¨ãƒ©ãƒ¼ã®å½±éŸ¿ç¯„å›²é™å®š** (ãƒãƒƒãƒå˜ä½)
5. **é€²æ—ã®å¯è¦–åŒ–** (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°)

### å®Ÿè£…ã®ç‰¹å¾´

- âœ… **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«**: ãƒ‡ãƒ¼ã‚¿é‡ãŒå¢—ãˆã¦ã‚‚å¯¾å¿œå¯èƒ½
- âœ… **å®‰å…¨**: å†ªç­‰æ€§ã«ã‚ˆã‚Šå†å®Ÿè¡ŒãŒå®‰å…¨
- âœ… **é«˜é€Ÿ**: ä¸¦åˆ—åŒ–ã®ä½™åœ°ã‚ã‚Šï¼ˆå°†æ¥çš„ãªæ‹¡å¼µï¼‰
- âœ… **æŸ”è»Ÿ**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ™å‹•ã‚’èª¿æ•´å¯èƒ½
- âœ… **ç›£è¦–å¯èƒ½**: ãƒ­ã‚°ã¨APIã§çŠ¶æ…‹ç¢ºèª

### ä»Šå¾Œã®æ‹¡å¼µå¯èƒ½æ€§

1. **Webhooké€£æº**: WordPressã§æ›´æ–°æ™‚ã«è‡ªå‹•åŒæœŸ
2. **å·®åˆ†åŒæœŸ**: å¤‰æ›´ãŒã‚ã£ãŸãƒ‡ãƒ¼ã‚¿ã®ã¿å–å¾—
3. **ä¸¦åˆ—å‡¦ç†**: è¤‡æ•°ãƒãƒƒãƒã‚’åŒæ™‚å®Ÿè¡Œ
4. **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼**: Cron Triggersã§å®šæœŸå®Ÿè¡Œ
5. **é€šçŸ¥æ©Ÿèƒ½**: ã‚¨ãƒ©ãƒ¼æ™‚ã®Slack/Emailã‚¢ãƒ©ãƒ¼ãƒˆ
